version: '3.8'

services:
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: genpulse
      POSTGRES_PASSWORD: secure_password
      POSTGRES_DB: genpulse_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U genpulse -d genpulse_db"]
      interval: 5s
      timeout: 3s
      retries: 5

  api:
    build: .
    restart: always
    command: api --host 0.0.0.0
    ports:
      - "8000:8000"
    environment:
      # Dynaconf overrides (ENV_FOR_DYNACONF defaults to development if not set)
      GENPULSE_ENV: "production"
      
      # Database
      GENPULSE_DATABASE_URL: "postgresql+asyncpg://genpulse:secure_password@postgres:5432/genpulse_db"
      
      # Redis Config
      GENPULSE_REDIS__URL: "redis://redis:6379/0"
      
      # MQ Config (Celery)
      GENPULSE_MQ__TYPE: "celery"
      GENPULSE_MQ__CELERY_BROKER_URL: "redis://redis:6379/0"
      GENPULSE_MQ__CELERY_RESULT_BACKEND: "redis://redis:6379/1"
      
      # Storage (Local by default)
      GENPULSE_STORAGE__TYPE: "local"
      GENPULSE_STORAGE__LOCAL_PATH: "/app/storage"
      
      # Storage - S3/OSS Example (Uncomment to use)
      # GENPULSE_STORAGE__TYPE: "s3"
      # GENPULSE_STORAGE__S3_ENDPOINT_URL: "https://oss-cn-hangzhou.aliyuncs.com"
      # GENPULSE_STORAGE__S3_ACCESS_KEY: "change_me"
      # GENPULSE_STORAGE__S3_SECRET_KEY: "change_me"
      # GENPULSE_STORAGE__S3_BUCKET_NAME: "genpulse"
      # GENPULSE_STORAGE__S3_REGION_NAME: "us-east-1"
      
      # Providers
      # Use host.docker.internal to access ComfyUI running on the host machine
      GENPULSE_PROVIDERS__COMFY_URL: "http://host.docker.internal:8188"

    extra_hosts:
      - "host.docker.internal:host-gateway"
      
    volumes:
      - genpulse_storage:/app/storage
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  worker:
    build: .
    restart: always
    command: worker
    # Share env vars with API (could use .env file to reduce duplication)
    environment:
      GENPULSE_ENV: "production"
      GENPULSE_DATABASE_URL: "postgresql+asyncpg://genpulse:secure_password@postgres:5432/genpulse_db"
      GENPULSE_REDIS__URL: "redis://redis:6379/0"
      GENPULSE_MQ__TYPE: "celery"
      GENPULSE_MQ__CELERY_BROKER_URL: "redis://redis:6379/0"
      GENPULSE_MQ__CELERY_RESULT_BACKEND: "redis://redis:6379/1"
      GENPULSE_STORAGE__TYPE: "local"
      GENPULSE_STORAGE__LOCAL_PATH: "/app/storage"
      # GENPULSE_STORAGE__TYPE: "s3"
      # GENPULSE_STORAGE__S3_ENDPOINT_URL: "https://oss-cn-hangzhou.aliyuncs.com"
      # GENPULSE_STORAGE__S3_ACCESS_KEY: "change_me"
      # GENPULSE_STORAGE__S3_SECRET_KEY: "change_me"
      # GENPULSE_STORAGE__S3_BUCKET_NAME: "genpulse"
      
      GENPULSE_PROVIDERS__COMFY_URL: "http://host.docker.internal:8188"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      - genpulse_storage:/app/storage
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  monitor:
    build: .
    restart: always
    command: monitor --port 5555
    ports:
      - "5555:5555"
    environment:
      GENPULSE_MQ__CELERY_BROKER_URL: "redis://redis:6379/0"
      GENPULSE_MQ__CELERY_RESULT_BACKEND: "redis://redis:6379/1"
    depends_on:
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  genpulse_storage:
